FROM condaforge/mambaforge:latest
ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /workspace

# ── 소스 복사 ─────────────────────────────────────────
COPY . /workspace
WORKDIR /workspace
#COPY FinRobot-master      ./FinRobot
#COPY FinEmotion-main     ./FinEmotion
#COPY FinRL_DeepSeek-main ./FinRL_llm
#COPY FinRL-master        ./FinRL

# Install Python and pip
# ── TA-lib C 라이브러리 설치 ────────────────────────────────────
RUN mamba install -y -c conda-forge ta-lib

# ── 시스템 툴 & Python ─────────────────────────────────
RUN mamba install -y \
        gcc gxx swig make cmake \
        python=3.10 pip \
      -c conda-forge

# ── 패키지 설치 (editable 제거!) ────────────────────────

RUN pip install --no-cache-dir ./FinRobot \
    && if [ -f ./FinRobot/requirements.txt ]; then \
         pip install --no-cache-dir -r ./FinRobot/requirements.txt; \
       fi \
    && pip install --no-cache-dir ./FinEmotion \
    && if [ -f ./FinEmotion/requirements.txt ]; then \
         pip install --no-cache-dir -r ./FinEmotion/requirements.txt; \
       fi \
    && pip install --no-cache-dir ./FinRL \
    && if [ -f ./FinRL/requirements.txt ]; then \
         pip install --no-cache-dir -r ./FinRL/requirements.txt; \
       fi
# ── 빌드 도구 업그레이드 (gym 설치 오류 방지) ──────────────────────
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# ── Gym 호환 버전 설치 (SB3 종속성 해결) ─────────────────────
RUN pip install --no-cache-dir gym==0.25.2

# ── ML 라이브러리 ───────────────────────────────────────
RUN pip install --no-cache-dir \
        torch==2.2.0 torchvision==0.17.0 torchaudio==2.2.0 \
        "stable-baselines3[extra]"

# ── 기타 과학 라이브러리 ─────────────────────────────────
RUN mamba install -y -c conda-forge \
        box2d-py mpi4py datasets huggingface_hub alpaca-py \
        selenium webdriver-manager gymnasium \
        matplotlib yfinance tqdm scikit-learn \
        tensorboard accelerate transformers

# ── PYTHONPATH 설정 ────────────────────────────────────────────
ENV PYTHONPATH="/workspace/FinRL"
WORKDIR /workspace/FinRL_llm
CMD ["mpirun", "-np", "8", "python", "train_ppo_llm.py"]
